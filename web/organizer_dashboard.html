<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizer Dashboard - College Event Management</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="welcome">
                <h2>Event Organizer Dashboard</h2>
                <p id="welcomeMsg"></p>
            </div>
            <div>
                <button class="btn-success" onclick="showCreateModal()">Create New Event</button>
                <button class="btn-primary" onclick="window.location.href='user_management.html'" style="margin-left: 10px;">User Management</button>
                <button class="btn-secondary" onclick="logout()" style="margin-left: 10px;">Logout</button>
            </div>
        </div>

        <div id="message"></div>

        <div style="background: white; padding: 20px; border-radius: 10px;">
            <h2>My Events</h2>
            <div id="eventsList"></div>
        </div>
    </div>

    <!-- Create Event Modal -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Create New Event</h2>
            <form action="createEvent" method="POST">
                <div class="form-group">
                    <label for="title">Event Title</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" required></textarea>
                </div>
                <div class="form-group">
                    <label for="eventDate">Event Date</label>
                    <input type="date" id="eventDate" name="eventDate" required>
                </div>
                <div class="form-group">
                    <label for="venue">Venue</label>
                    <input type="text" id="venue" name="venue" required>
                </div>
                <button type="submit">Create Event</button>
            </form>
        </div>
    </div>

    <!-- View Registrations Modal -->
    <div id="registrationsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRegistrationsModal()">&times;</span>
            <h2>Event Registrations</h2>
            <div id="registrationsList"></div>
        </div>
    </div>

    <script>
        function logout() {
            window.location.href = 'logout';
        }

        function showCreateModal() {
            document.getElementById('createModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('createModal').style.display = 'none';
        }

        function closeRegistrationsModal() {
            document.getElementById('registrationsModal').style.display = 'none';
        }

        async function viewRegistrations(eventId, eventTitle) {
            try {
                const response = await fetch(`getRegistrations?eventId=${eventId}`);
                const registrations = await response.json();
                
                const regList = document.getElementById('registrationsList');
                
                if (registrations.length === 0) {
                    regList.innerHTML = '<p style="color: #666;">No students registered yet.</p>';
                } else {
                    let html = '<table><tr><th>Student Name</th><th>Email</th><th>Department</th><th>Year</th><th>Phone</th><th>Registered At</th></tr>';
                    registrations.forEach(reg => {
                        html += `
                            <tr>
                                <td>${reg.fullName}</td>
                                <td>${reg.email}</td>
                                <td>${reg.department || 'N/A'}</td>
                                <td>${reg.year || 'N/A'}</td>
                                <td>${reg.phone || 'N/A'}</td>
                                <td>${new Date(reg.registeredAt).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    regList.innerHTML = html;
                }
                
                document.getElementById('registrationsModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading registrations:', error);
            }
        }

        const params = new URLSearchParams(window.location.search);
        const msg = document.getElementById('message');
        
        if (params.get('success') === 'created') {
            msg.innerHTML = '<div class="message success">Event created and sent to admin for approval!</div>';
        }

        async function loadEvents() {
            try {
                const response = await fetch('getEvents');
                const events = await response.json();
                
                const eventsList = document.getElementById('eventsList');
                
                if (events.length === 0) {
                    eventsList.innerHTML = '<p style="color: #666;">You haven\'t created any events yet.</p>';
                    return;
                }
                
                let html = '';
                events.forEach(event => {
                    let statusClass = 'status-' + event.status;
                    html += `
                        <div class="event-card">
                            <h3>${event.title} <span class="${statusClass} status-badge">${event.status.toUpperCase()}</span></h3>
                            <p class="event-info"><strong>Description:</strong> ${event.description}</p>
                            <p class="event-info"><strong>Date:</strong> ${event.eventDate}</p>
                            <p class="event-info"><strong>Venue:</strong> ${event.venue}</p>
                            ${event.status === 'approved' ? 
                                `<div class="action-buttons">
                                    <button class="btn-success" onclick="viewRegistrations(${event.id}, '${event.title}')">View Registrations</button>
                                </div>` : ''}
                        </div>
                    `;
                });
                
                eventsList.innerHTML = html;
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        loadEvents();
    </script>
</body>
</html>
