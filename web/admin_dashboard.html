<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - College Event Management</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="welcome">
                <h2>Admin Dashboard</h2>
                <p id="welcomeMsg"></p>
            </div>
            <button class="btn-secondary" onclick="logout()">Logout</button>
        </div>

        <div id="message"></div>

        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h2>Pending Events Approval</h2>
            <div id="pendingEventsList"></div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h2>All Events</h2>
            <div id="allEventsList"></div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 10px;">
            <h2>User Management</h2>
            <div id="usersList"></div>
        </div>
    </div>

    <!-- Change Role Modal -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRoleModal()">&times;</span>
            <h2>Change User Role</h2>
            <form id="roleForm" action="manageUsers" method="POST">
                <input type="hidden" name="action" value="changeRole">
                <input type="hidden" name="userId" id="roleUserId">
                <div class="form-group">
                    <label for="newRole">New Role</label>
                    <select id="newRole" name="newRole" required>
                        <option value="student">Student</option>
                        <option value="organizer">Event Organizer</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit">Change Role</button>
            </form>
        </div>
    </div>

    <script>
        function logout() {
            window.location.href = 'logout';
        }

        function closeRoleModal() {
            document.getElementById('roleModal').style.display = 'none';
        }

        function showRoleModal(userId, currentRole) {
            document.getElementById('roleUserId').value = userId;
            document.getElementById('newRole').value = currentRole;
            document.getElementById('roleModal').style.display = 'block';
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'manageUsers';
                
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'delete';
                
                const userIdInput = document.createElement('input');
                userIdInput.type = 'hidden';
                userIdInput.name = 'userId';
                userIdInput.value = userId;
                
                form.appendChild(actionInput);
                form.appendChild(userIdInput);
                document.body.appendChild(form);
                form.submit();
            }
        }

        function approveEvent(eventId, action) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'approveEvent';
            
            const eventIdInput = document.createElement('input');
            eventIdInput.type = 'hidden';
            eventIdInput.name = 'eventId';
            eventIdInput.value = eventId;
            
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = action;
            
            form.appendChild(eventIdInput);
            form.appendChild(actionInput);
            document.body.appendChild(form);
            form.submit();
        }

        const params = new URLSearchParams(window.location.search);
        const msg = document.getElementById('message');
        
        if (params.get('success') === 'updated') {
            msg.innerHTML = '<div class="message success">Action completed successfully!</div>';
        }

        async function loadEvents() {
            try {
                const response = await fetch('getEvents');
                const events = await response.json();
                
                const pendingEvents = events.filter(e => e.status === 'pending');
                const allEvents = events;
                
                const pendingList = document.getElementById('pendingEventsList');
                if (pendingEvents.length === 0) {
                    pendingList.innerHTML = '<p style="color: #666;">No pending events.</p>';
                } else {
                    let html = '';
                    pendingEvents.forEach(event => {
                        html += `
                            <div class="event-card">
                                <h3>${event.title}</h3>
                                <p class="event-info"><strong>Description:</strong> ${event.description}</p>
                                <p class="event-info"><strong>Date:</strong> ${event.eventDate}</p>
                                <p class="event-info"><strong>Venue:</strong> ${event.venue}</p>
                                <p class="event-info"><strong>Organized by:</strong> ${event.organizerName}</p>
                                <div class="action-buttons">
                                    <button class="btn-success" onclick="approveEvent(${event.id}, 'approved')">Approve</button>
                                    <button class="btn-danger" onclick="approveEvent(${event.id}, 'rejected')">Reject</button>
                                </div>
                            </div>
                        `;
                    });
                    pendingList.innerHTML = html;
                }
                
                const allList = document.getElementById('allEventsList');
                if (allEvents.length === 0) {
                    allList.innerHTML = '<p style="color: #666;">No events created yet.</p>';
                } else {
                    let html = '';
                    allEvents.forEach(event => {
                        let statusClass = 'status-' + event.status;
                        html += `
                            <div class="event-card">
                                <h3>${event.title} <span class="${statusClass} status-badge">${event.status.toUpperCase()}</span></h3>
                                <p class="event-info"><strong>Description:</strong> ${event.description}</p>
                                <p class="event-info"><strong>Date:</strong> ${event.eventDate}</p>
                                <p class="event-info"><strong>Venue:</strong> ${event.venue}</p>
                                <p class="event-info"><strong>Organized by:</strong> ${event.organizerName}</p>
                            </div>
                        `;
                    });
                    allList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('manageUsers');
                const users = await response.json();
                
                const usersList = document.getElementById('usersList');
                
                if (users.length === 0) {
                    usersList.innerHTML = '<p style="color: #666;">No users found.</p>';
                    return;
                }
                
                let html = '<table><tr><th>Username</th><th>Full Name</th><th>Email</th><th>Role</th><th>Actions</th></tr>';
                users.forEach(user => {
                    html += `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.fullName}</td>
                            <td>${user.email}</td>
                            <td>${user.role}</td>
                            <td>
                                <button class="btn-warning" onclick="showRoleModal(${user.id}, '${user.role}')">Change Role</button>
                                ${user.role !== 'admin' ? `<button class="btn-danger" onclick="deleteUser(${user.id})">Delete</button>` : ''}
                            </td>
                        </tr>
                    `;
                });
                html += '</table>';
                
                usersList.innerHTML = html;
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        loadEvents();
        loadUsers();
    </script>
</body>
</html>
